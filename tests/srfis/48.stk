;; ----------------------------------------------------------------------
;;  SRFI 48 ...
;; ----------------------------------------------------------------------

(parameterize
    ((real-precision 6))
  (test "original.1" (format "test ~s" 'me) (format #f "test ~a" "me"))
  (test "original.2"  " 0.333" (format "~6,3F" 1/3)) ;;; "  .333" OK
  (test "original.3" "  12" (format "~4F" 12))
  (test "original.4" "  12.346" (format "~8,3F" 12.3456))
  (test "original.5" "123.346" (format "~6,3F" 123.3456))
  (test "original.6" "123.346" (format "~4,3F" 123.3456))
  (test "original.7" "0.000+1.949i" (format "~8,3F" (sqrt -3.8)))
  (test "original.8" " 32.00" (format "~6,2F" 32))
  (test "original.9" "    32" (format "~6F" 32))
  (test "original.10" "  32.0" (format "~6F" 32.))
  ;; NB: (not (and (exact? 32.) (integer? 32.)))
  (test "original.11" " 3.2e+46" (format "~8F" 32e45))
  (test "original.12" " 3.2e-44" (format "~8F" 32e-45))
  (test "original.13" " 3.2e+21" (format "~8F" 32e20))
  (test "original.14" "  3200.0" (format "~8F" 32e2))
  (test "original.15" "3.20e+11" (format "~8,2F" 32e10))
  (test "original.16" "      1.2345" (format "~12F" 1.2345))
  (test "original.17" "        1.23" (format "~12,2F" 1.2345))
  (test "original.18" "       1.234" (format "~12,3F" 1.2345))
  (test "original.19" "        0.000+1.949i" (format "~20,3F" (sqrt -3.8)))
  (test "original.20" "0.000+1.949i" (format "~8,3F" (sqrt -3.8)))
  (test "original.21" "3.46e+11" (format "~8,2F" 3.4567e11))
  (test "original.22" "#0=(a b c . #0#)"
        (format "~w" (let ( (c (list 'a 'b 'c)) ) (set-cdr! (cddr c) c) c)))
  (test "original.23" "\n"
        (format "~A~A~&" (list->string (list #\newline)) ""))
  (test "original.24" "a new test"
        (format "~a ~? ~a" 'a "~s" '(new) 'test))
  (test "original.25" "a new test, yes!"
        (format "~a ~?, ~a!" 'a "~s ~a" '(new test) 'yes))
  (test "original.26" "3.46e+20"  (format "~8,2F" 3.4567e20))
  (test "original.27" "3.46e+21"  (format "~8,2F" 3.4567e21))
  (test "original.28" "3.46e+22"  (format "~8,2F" 3.4567e22))
  (test "original.29" "3.46e+23"  (format "~8,2F" 3.4567e23))
  (test "original.30" "  3.e+24"   (format "~8,0F" 3.4567e24))
  (test "original.31" " 3.5e+24"   (format "~8,1F" 3.4567e24))
  (test "original.32" "3.46e+24"   (format "~8,2F" 3.4567e24))
  (test "original.33" "3.457e+24"  (format "~8,3F" 3.4567e24))
  (test "original.34" "  4.e+24"   (format "~8,0F" 3.5567e24))
  (test "original.35" " 3.6e+24"   (format "~8,1F" 3.5567e24))
  (test "original.36" "3.56e+24"   (format "~8,2F" 3.5567e24))
  (test "original.37" "       -0." (format "~10,0F" -3e-4))
  (test "original.38" "      -0.0" (format "~10,1F" -3e-4))
  (test "original.39" "     -0.00" (format "~10,2F" -3e-4))
  (test "original.40" "    -0.000" (format "~10,3F" -3e-4))
  (test "original.41" "   -0.0003" (format "~10,4F" -3e-4))
  (test "original.42" "  -0.00030" (format "~10,5F" -3e-4))
  (test "original.43" "     1.020" (format "~10,3F" 1.02))
  (test "original.44" "     1.025" (format "~10,3F" 1.025))
  (test "original.45" "     1.026" (format "~10,3F" 1.0256))
  (test "original.46" "     1.002" (format "~10,3F" 1.002))
  (test "original.47" "     1.002" (format "~10,3F" 1.0025))
  (test "original.48" "     1.003" (format "~10,3F" 1.00256))


  (test "examples.1" "    0.33"   (format "~8,2F" 1/3))
  (test "examples.2" "    32"     (format "~6F" 32))
  (test "examples.3" "   32.00"   (format "~8,2F" 32))
  (test "examples.4" "4321.00"    (format "~1,2F" 4321))
  (test "examples.5" "0.00+1.97i" (format "~1,2F" (sqrt -3.9)))
  (test "examples.6" " 3.2e+06"   (format "~8F" 32e5))
  (test "examples.7" "3.21e+06"   (format "~8F" 321e4))
  (test "examples.8" "<string>"   (format "~h") (lambda (e r) (string? r)))
  (test "examples.9" "Hello, World!" (format "Hello, ~a" "World!"))
  (test "examples.10" "Error, list is too short: (one \"two\" 3)"
        (format "Error, list is too short: ~s" '(one "two" 3)))
  (test "examples.11" "test me"    (format "test me"))
  (test "examples.12" "this is a \"test\"" (format "~a ~s ~a ~s" 'this 'is "a" "test"))
  (test "examples.13" "#d32 #x20 #o40 #b100000\n"
        (format "#d~d #x~x #o~o #b~b~%" 32 32 32 32))
  (test "examples.14" "a new test" (format "~a ~? ~a" 'a "~s" '(new) 'test))
  (test "examples.15" "\n1\n2\n3\n" (format #f "~&1~&~&2~&~&~&3~%"))
  (test "examples.16" "3  2 2  3 \n" (format #f "~a ~? ~a ~%" 3 " ~s ~s " '(2 2) 3))
  (test "examples.17" "#0=(a b c . #0#)"
        (format "~w" (let ((c (list 'a 'b 'c)))
                       (set-cdr! (cddr c) c) c)))
  (test "examples.18" "   32.00" (format "~8,2F" 32))
  (test "examples.19" "0.000+1.949i" (format "~8,3F" (sqrt -3.8)))
  (test "examples.20" "3.46e+11"   (format "~8,2F" 3.4567e11))
  (test "examples.21" " 0.333"     (format "~6,3F" 1/3))
  (test "examples.22" "  12"       (format "~4F" 12))
  (test "examples.23" " 123.346"   (format "~8,3F" 123.3456))
  (test "examples.24" "123.346"    (format "~6,3F" 123.3456))
  (test "examples.25" "123.346"    (format "~2,3F" 123.3456))
  (test "examples.26" "     foo"   (format "~8,3F" "foo"))
  (test "examples.27" "\n"         (format "~a~a~&" (list->string (list #\newline)) ""))


  (test "~F normal.1" "0"          (format "~F"    0))
  (test "~F normal.2" "1"          (format "~F"    1))
  (test "~F normal.3" "123"        (format "~F"  123))
  (test "~F normal.4" "0.456"      (format "~F"    0.456))
  (test "~F normal.5" "123.456"    (format "~F"  123.456))
  (test "~F normal.6" "-1"         (format "~F"   -1))
  (test "~F normal.7" "-123"       (format "~F" -123))
  (test "~F normal.8" "-0.456"     (format "~F"   -0.456))
  (test "~F normal.9" "-123.456"   (format "~F" -123.456))


  (test "~F width.1" "123"         (format "~0F"  123))
  (test "~F width.2" "123"         (format "~1F"  123))
  (test "~F width.3" "123"         (format "~2F"  123))
  (test "~F width.4" "123"         (format "~3F"  123))
  (test "~F width.5" " 123"        (format "~4F"  123))
  (test "~F width.6" "  123"       (format "~5F"  123))
  (test "~F width.7" "-123"        (format "~3F" -123))
  (test "~F width.8" "-123"        (format "~4F" -123))
  (test "~F width.9" " -123"       (format "~5F" -123))
  (test "~F width.10" "  -123"     (format "~6F" -123))

  (test "~F disgits.1" "123."        (format "~1,0F"   123))
  (test "~F disgits.2" "123.0"       (format "~1,1F"   123))
  (test "~F disgits.3" "123.00"      (format "~1,2F"   123))
  (test "~F disgits.4" "0.12"        (format "~1,2F"   0.123))
  (test "~F disgits.5" "0.123"       (format "~1,3F"   0.123))
  (test "~F disgits.6" "0.1230"      (format "~1,4F"   0.123))
  (test "~F disgits.7" "-123."       (format "~1,0F"  -123))
  (test "~F disgits.8" "-123.0"      (format "~1,1F"  -123))
  (test "~F disgits.9" "-123.00"     (format "~1,2F"  -123))
  (test "~F disgits.10" "-0.12"      (format "~1,2F"  -0.123))
  (test "~F disgits.11" "-0.123"     (format "~1,3F"  -0.123))
  (test "~F disgits.12" "-0.1230"    (format "~1,4F"  -0.123))


  (test "~F rounding.1" "123."        (format "~1,0F"   123.456))
  (test "~F rounding.3" "123.5"       (format "~1,1F"   123.456))
  (test "~F rounding.4" "123.46"      (format "~1,2F"   123.456))
  (test "~F rounding.5" "-123."       (format "~1,0F"  -123.456))
  (test "~F rounding.6" "-123.5"      (format "~1,1F"  -123.456))
  (test "~F rounding.7" "-123.46"     (format "~1,2F"  -123.456))
  (test "~F rounding.8" "123.0"       (format "~1,1F"   123.05))
  (test "~F rounding.9" "123.2"       (format "~1,1F"   123.15))
  (test "~F rounding.10" "124.0"      (format "~1,1F"   123.95))
  (test "~F rounding.11" "-123.0"     (format "~1,1F"  -123.05))
  (test "~F rounding.12" "-123.2"     (format "~1,1F"  -123.15))
  (test "~F rounding.13" "-124.0"     (format "~1,1F"  -123.95))
  (test "~F rounding.14" "1000.00"    (format "~1,2F"   999.995))
  (test "~F rounding.15" "-1000.00"   (format "~1,2F"  -999.995))
  (test "~F rounding.16" "1."         (format "~1,0F"   1.49))
  (test "~F rounding.17" "2."         (format "~1,0F"   1.5))
  (test "~F rounding.18" "2."         (format "~1,0F"   1.51))
  (test "~F rounding.19" "2."         (format "~1,0F"   2.49))
  (test "~F rounding.20" "2."         (format "~1,0F"   2.5))
  (test "~F rounding.21" "3."         (format "~1,0F"   2.51))

  (test "~F Misc.1" "+inf.0"      (format "~F" +inf.0))
  (test "~F Misc.2" "-inf.0"      (format "~F" -inf.0))
  (test "~F Misc.3" "+nan.0"      (format "~F" +nan.0))
  (test "~F Misc.4" "0.0"         (format "~F" 0.0))
  (test "~F Misc.5" "-0.0"        (format "~F" -0.0))
  (test "~F Misc.6" "+inf.0"      (format "~1F" +inf.0))
  (test "~F Misc.7" "-inf.0"      (format "~1F" -inf.0))
  (test "~F Misc.8" "+nan.0"      (format "~1F" +nan.0))
  (test "~F Misc.9" "0.0"         (format "~1F" 0.0))
  (test "~F Misc.10" "-0.0"       (format "~1F" -0.0))
  (test "~F Misc.11" "+inf.0"     (format "~1,0F" +inf.0))
  (test "~F Misc.12" "-inf.0"     (format "~1,0F" -inf.0))
  (test "~F Misc.13" "+nan.0"     (format "~1,0F" +nan.0))
  (test "~F Misc.14" "0."         (format "~1,0F" 0.0))
  (test "~F Misc.15" "-0."        (format "~1,0F" -0.0))
  (test "~F Misc.16" "+inf.0"     (format "~1,1F" +inf.0))
  (test "~F Misc.17" "-inf.0"     (format "~1,1F" -inf.0))
  (test "~F Misc.18" "+nan.0"     (format "~1,1F" +nan.0))
  (test "~F Misc.19" "0.0"        (format "~1,1F" 0.0))
  (test "~F Misc.20" "-0.0"       (format "~1,1F" -0.0))

  (parameterize
      ((real-precision 15))

    (let ((pi 3.141592653589793))
      (test "~F Misc.21" "31.4159265358979"
            (format "~F" (* pi 10))))
    (test "~F Misc.22" "0.33333"    (format "~1,5F"  1/3))
    (test "~F Misc.23" "-0.33333"   (format "~1,5F" -1/3))
    (test "~F Misc.24" "0.142857142857" (format "~1,12F"  1/7))
    (test "~F Misc.25" #t
          (< (abs (- (string->number "299999999.999999999")
                     (string->number
                      (format "~F" 299999999999999999/1000000000))))
             1e-10))
    (test "~F Misc.26" "1.797693e+308"  (format "~F"     1.797693e308))
    (test "~F Misc.27" "1.797693e+308"  (format "~1F"    1.797693e308))
    (test "~F Misc.28" "2.e+308"        (format "~1,0F"  1.797693e308))
    (test "~F Misc.29" "1.8e+308"       (format "~1,1F"  1.797693e308))
    (test "~F Misc.30" "-1.797693e+308" (format "~F"    -1.797693e308))
    (test "~F Misc.31" "-1.797693e+308" (format "~1F"   -1.797693e308))
    (test "~F Misc.32" "-2.e+308"       (format "~1,0F" -1.797693e308))
    (test "~F Misc.33" "-1.8e+308"      (format "~1,1F" -1.797693e308))
    (test "~F Misc.34" "2.225074e-308"  (format "~F"  2.225074e-308))
    (test "~F Misc.35" "5.02"           (format "~1,2F" 5.015))
    (test "~F Misc.36" "6.00"           (format "~1,2F" 5.999))
    (test "~F Misc.37" "123."           (format "~1,0F" 123.00))
    (test "~F Misc.38" "0.1"            (format "~F" .1))
    (test "~F Misc.39" "1"              (format "~1f" 1)) ; lower case f
    (test "~F Misc.40" "1.e+100"        (format "~1,0F" 1e100))
    (test "~F Misc.41" "1."             (format "~1,0F" 1))
    (test "~F Misc.42" "0."             (format "~1,0F" .1))
    (test "~F Misc.43" "0.0"            (format "~1,1F" .01))

    (test "from mailing list.1" "1.230e+20" (format "~0,3F" 1.23e20))
    (test "from mailing list.2" "1.230e-20" (format "~0,3F" 1.23e-20))

    (test "from mailing list.3" "3.457e+15" (format "~8,3F" 3.4569e15))
    (test "from mailing list.4" "   3.457"  (format "~8,3F" 3.4569))
    (test "from mailing list.5" "3.46e+15"  (format "~8,2F" 3.456e15))
    (test "from mailing list.6" "    3.46"  (format "~8,2F" 3.456))


    (test "from mailing list.7" "       -0."   (format "~10,0F" -3e-4))
    (test "from mailing list.8" "      -0.0"   (format "~10,1F" -3e-4))
    (test "from mailing list.9" "     -0.00"   (format "~10,2F" -3e-4))
    (test "from mailing list.10" "    -0.000"  (format "~10,3F" -3e-4))
    (test "from mailing list.11" "   -0.0003"  (format "~10,4F" -3e-4))
    (test "from mailing list.12" "3.0000e-05" (format "~10,4F"  3e-5))


    (test "from mailing list.13" "     1.020" (format "~10,3F" 1.02))
    (test "from mailing list.14" "     1.025" (format "~10,3F" 1.025))
    (test "from mailing list.15" "     1.026" (format "~10,3F" 1.0256))
    (test "from mailing list.16" "     1.002" (format "~10,3F" 1.002))
    (test "from mailing list.17" "     1.002" (format "~10,3F" 1.0025))
    (test "from mailing list.18" "     1.003" (format "~10,3F" 1.00256))

    (test "from mailing list.19" "1.000012"   (format "~8,6F" 1.00001234))

    (test "from mailing list.20" "abc\ndef\nghi\n" (format "abc~%~&def~&ghi~%"))
    (test "from mailing list.21" "\ndef\nghi\n" (format "~&def~&ghi~%"))


    (test "from mailing list.22" "   1.00"    (format "~7,2F" .997554209949891))
    (test "from mailing list.23" "   1.00"    (format "~7,2F" .99755))
    (test "from mailing list.24" "   1.00"    (format "~7,2F" .9975))
    (test "from mailing list.25" "   1.00"    (format "~7,2F" .997))
    (test "from mailing list.26" "   0.99"    (format "~7,2F" .99))

    (test "from mailing list.27" "  18.00"    (format "~7,2F" 18.0000000000008))
    (test "from mailing list.28" "    -15."   (format "~8,0F" -14.99995999999362)))
  )


